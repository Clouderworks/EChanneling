<div *ngIf="!auth.isAdmin()" class="alert alert-danger">You do not have permission to view user management.</div>
<div *ngIf="auth.isAdmin()">
  <h2>User Management</h2>
  <div *ngIf="loading" class="loading-spinner" aria-live="polite" aria-busy="true" tabindex="0">
    <span class="visually-hidden">Loading users...</span>
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" aria-hidden="true">
      <circle cx="16" cy="16" r="14" stroke="#1565c0" stroke-width="4" opacity="0.2" />
      <path d="M30 16a14 14 0 0 1-14 14" stroke="#1565c0" stroke-width="4" stroke-linecap="round">
        <animateTransform attributeName="transform" type="rotate" from="0 16 16" to="360 16 16" dur="1s" repeatCount="indefinite" />
      </path>
    </svg>
  </div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
  <div style="display:flex; align-items:center; gap:1rem; margin-bottom:0.5rem;">
    <button class="btn btn-primary mb-2" (click)="openCreate()" accesskey="c" aria-keyshortcuts="Alt+C">Create User</button>
    <input type="search" [(ngModel)]="filter" placeholder="Filter by username" aria-label="Filter users" style="padding:0.3rem 0.7rem; border-radius:4px; border:1px solid #ccc; min-width:180px;" />
  </div>
  <table *ngIf="pagedUsers.length" class="table table-striped table-sm mt-3" aria-label="User list">
    <thead>
      <tr>
        <th scope="col">Username</th>
        <th scope="col">Roles</th>
        <th scope="col">Status</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
  <tr *ngFor="let user of pagedUsers">
        <td>{{ user.username }}</td>
        <td>
          <select multiple [(ngModel)]="user.roles" (change)="updateUser(user)" [attr.aria-label]="'Roles for ' + user.username">
            <option *ngFor="let role of roles" [value]="role.name">{{ role.name }}</option>
          </select>
        </td>
        <td>
          <span [ngClass]="{'text-success': user.isActive, 'text-danger': !user.isActive}" [attr.aria-label]="user.isActive ? 'Active' : 'Inactive'">
            {{ user.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
        <td>
            <button class="btn btn-sm btn-danger" [disabled]="!user.isActive" (click)="deactivateUser(user)" [attr.aria-label]="'Deactivate ' + user.username">Deactivate</button>
        </td>
      </tr>
    </tbody>
  </table>
  <div *ngIf="!pagedUsers.length && !loading">No users found.</div>

  <nav *ngIf="totalPages > 1" aria-label="User list pagination" style="margin-top:1rem;">
    <ul style="display:flex; list-style:none; gap:0.5rem; padding:0;">
      <li><button class="btn btn-sm" (click)="setPage(page-1)" [disabled]="page===1" aria-label="Previous page">&laquo;</button></li>
      <li *ngFor="let p of [].constructor(totalPages); let i = index">
        <button class="btn btn-sm" [class.active-page]="page===i+1" (click)="setPage(i+1)" [attr.aria-current]="page===i+1 ? 'page' : null">{{i+1}}</button>
      </li>
      <li><button class="btn btn-sm" (click)="setPage(page+1)" [disabled]="page===totalPages" aria-label="Next page">&raquo;</button></li>
    </ul>
  </nav>

  <div *ngIf="showCreate" class="modal" role="dialog" aria-modal="true" aria-labelledby="createUserTitle" tabindex="-1">
    <div class="modal-content">
      <h3 id="createUserTitle">Create User</h3>
      <form (ngSubmit)="createUser()" autocomplete="off">
        <label for="new-username">Username:</label>
        <input id="new-username" [(ngModel)]="newUser.username" name="username" required minlength="3" aria-required="true" autofocus (keydown.enter)="$event.stopPropagation()" />
        <label for="new-roles">Roles:</label>
        <select id="new-roles" multiple [(ngModel)]="newUser.roles" name="roles" aria-required="true">
          <option *ngFor="let role of roles" [value]="role.name">{{ role.name }}</option>
        </select>
        <div style="margin-top:1rem;">
          <button class="btn btn-success" type="submit" [disabled]="!newUser.username || !newUser.roles?.length" accesskey="s" aria-keyshortcuts="Alt+S">Create</button>
          <button class="btn btn-secondary" type="button" (click)="showCreate = false" accesskey="x" aria-keyshortcuts="Alt+X">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
